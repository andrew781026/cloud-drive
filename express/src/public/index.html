<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="data-storage.ico">
    <title>åˆ†å¡Šä¸Šå‚³æª”æ¡ˆ</title>
</head>
<body>
<input type="file" id="files" multiple="multiple"/><br><br>
<button onclick="upload()">ä¸Šå‚³æª”æ¡ˆ</button>


<script>

    /**
     * åƒè€ƒè³‡æ–™ : https://joji.me/zh-cn/blog/processing-huge-files-using-filereader-readasarraybuffer-in-web-browser/
     *          https://medium.com/@vecera.petr/how-to-handle-large-file-upload-with-nodejs-express-server-7de9ab3f7af1
     * */
    function upload() {

        let file = document.getElementById('files').files[0];
        let reader = new FileReader();
        let CHUNK_SIZE = 10 * 1024;
        let processTimes = 0;

        reader.onload = function (fileReader) {
            let buffer = new Uint8Array(fileReader.result);

            console.log('file=', file)

            // send the buffer to api server
            sendTypedArray(buffer, file.name);
        }

        reader.onloadend = function (fileReader) {
            console.log('onloadend ğŸš€');
            console.log(fileReader);
            if (++processTimes < 3) seek();
        }

        seek();

        function sendTypedArray(typedArray, fileName) {

            fetch('http://localhost:3011/file/upload/bytes', {
                body: JSON.stringify({bytes: typedArray, fileName}), // must match 'Content-Type' header
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, same-origin, *omit
                headers: {
                    'user-agent': 'Mozilla/4.0 MDN Example',
                    'content-type': 'application/json'
                },
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, cors, *same-origin
                // redirect: 'follow', // manual, *follow, error
                // referrer: 'no-referrer', // *client, no-referrer
            })
            // .then(console.log)
            // .catch(console.error);
        }

        // åˆ‡åˆ†å¥½å¹¾å¡Š , ç„¶å¾Œæœ€å¾ŒæŠŠæª”æ¡ˆ merge èµ·ä¾†
        function seek() {

            let start = 0;
            let next = (processTimes + 1) * CHUNK_SIZE;
            let end = CHUNK_SIZE;

            // cutting big files to small chunks
            let slice = file.slice(start, end);
            reader.readAsArrayBuffer(slice);
        }
    }
</script>
</body>
</html>